<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Ch√∫t Chill - L·ªùi m·ªùi tham gia nh√≥m</title>
  <meta name="description" content="B·∫°n ƒë∆∞·ª£c m·ªùi tham gia nh√≥m tr√™n Ch√∫t Chill" />
  <meta property="og:title" content="Ch√∫t Chill - L·ªùi m·ªùi nh√≥m" />
  <meta property="og:description" content="B·∫•m ƒë·ªÉ tham gia nh√≥m tr√™n app Ch√∫t Chill" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet" />
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Nunito', sans-serif;
      min-height: 100vh;
      background: linear-gradient(160deg, #E8F4FF 0%, #B8DFFF 40%, #A8D4FF 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      overflow: hidden;
    }

    /* M√¢y trang tr√≠ */
    .cloud {
      position: fixed;
      background: rgba(255,255,255,0.35);
      border-radius: 100px;
      filter: blur(1px);
    }
    .cloud::before, .cloud::after {
      content: '';
      position: absolute;
      background: inherit;
      border-radius: 50%;
    }
    .cloud-1 { width: 140px; height: 46px; top: 8%; left: -20px; animation: floatCloud 18s ease-in-out infinite; }
    .cloud-1::before { width: 60px; height: 60px; top: -28px; left: 22px; }
    .cloud-1::after { width: 45px; height: 45px; top: -18px; right: 20px; }
    .cloud-2 { width: 110px; height: 36px; top: 15%; right: -10px; animation: floatCloud 22s ease-in-out infinite reverse; }
    .cloud-2::before { width: 50px; height: 50px; top: -24px; left: 16px; }
    .cloud-2::after { width: 38px; height: 38px; top: -14px; right: 14px; }
    .cloud-3 { width: 100px; height: 32px; bottom: 12%; left: 10%; animation: floatCloud 20s ease-in-out infinite; opacity: 0.5; }
    .cloud-3::before { width: 44px; height: 44px; top: -20px; left: 14px; }
    .cloud-3::after { width: 34px; height: 34px; top: -12px; right: 12px; }

    @keyframes floatCloud {
      0%, 100% { transform: translateX(0); }
      50% { transform: translateX(30px); }
    }

    /* Container ch√≠nh */
    .card {
      background: rgba(255,255,255,0.82);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1.5px solid rgba(255,255,255,0.9);
      border-radius: 28px;
      padding: 36px 28px;
      max-width: 380px;
      width: 100%;
      text-align: center;
      box-shadow: 0 12px 40px rgba(100,160,200,0.15);
      animation: cardIn 0.6s ease-out;
      position: relative;
      z-index: 10;
    }

    @keyframes cardIn {
      from { opacity: 0; transform: translateY(30px) scale(0.95); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }

    .logo-text {
      font-size: 28px;
      font-weight: 800;
      color: #7ABFD4;
      letter-spacing: 2px;
      margin-bottom: 4px;
    }
    .logo-sub {
      font-size: 12px;
      color: #A0A0C0;
      margin-bottom: 24px;
    }

    /* Avatar nh√≥m */
    .group-avatar {
      width: 88px;
      height: 88px;
      border-radius: 50%;
      background: linear-gradient(135deg, #CFE9FF, #A8D4FF);
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 16px;
      border: 3px solid rgba(255,255,255,0.9);
      box-shadow: 0 4px 14px rgba(122,191,212,0.3);
      font-size: 36px;
    }
    .group-avatar img {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
    }

    .group-name {
      font-size: 22px;
      font-weight: 800;
      color: #4A4A6A;
      margin-bottom: 6px;
    }
    .group-members {
      font-size: 14px;
      color: #7A7A9A;
      margin-bottom: 6px;
    }
    .group-desc {
      font-size: 13px;
      color: #A0A0C0;
      margin-bottom: 20px;
      line-height: 1.5;
    }

    .invite-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(122,191,212,0.1);
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 12px;
      color: #7ABFD4;
      font-weight: 600;
      margin-bottom: 24px;
    }

    /* N√∫t m·ªü app */
    .btn-open {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      width: 100%;
      padding: 15px 24px;
      background: linear-gradient(135deg, #7ABFD4, #5AACCC);
      color: #FFF;
      font-size: 16px;
      font-weight: 700;
      border: none;
      border-radius: 20px;
      cursor: pointer;
      transition: transform 0.15s, box-shadow 0.15s;
      box-shadow: 0 4px 14px rgba(122,191,212,0.4);
      text-decoration: none;
    }
    .btn-open:active { transform: scale(0.97); }

    .btn-download {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      width: 100%;
      padding: 13px 24px;
      background: rgba(74,74,106,0.08);
      color: #4A4A6A;
      font-size: 14px;
      font-weight: 700;
      border: none;
      border-radius: 18px;
      cursor: pointer;
      margin-top: 12px;
      text-decoration: none;
      transition: background 0.15s;
    }
    .btn-download:hover { background: rgba(74,74,106,0.14); }

    .status-text {
      margin-top: 16px;
      font-size: 12px;
      color: #A0A0C0;
    }

    /* Loading */
    .loading {
      padding: 40px 0;
    }
    .spinner {
      width: 36px;
      height: 36px;
      border: 3px solid rgba(122,191,212,0.2);
      border-top-color: #7ABFD4;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 12px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Error */
    .error-icon {
      font-size: 48px;
      margin-bottom: 12px;
    }
    .error-title {
      font-size: 18px;
      font-weight: 700;
      color: #FF4757;
      margin-bottom: 6px;
    }
    .error-sub {
      font-size: 13px;
      color: #7A7A9A;
      margin-bottom: 20px;
    }

    .hidden { display: none; }
  </style>
</head>
<body>
  <!-- M√¢y trang tr√≠ -->
  <div class="cloud cloud-1"></div>
  <div class="cloud cloud-2"></div>
  <div class="cloud cloud-3"></div>

  <div class="card">
    <div class="logo-text">Ch√∫t Chill</div>
    <div class="logo-sub">K·∫øt n·ªëi b·∫°n b√®, chia s·∫ª kho·∫£nh kh·∫Øc ‚òÅÔ∏è</div>

    <!-- Loading State -->
    <div id="loading" class="loading">
      <div class="spinner"></div>
      <div style="font-size:14px; color:#7A7A9A;">ƒêang t·∫£i th√¥ng tin nh√≥m...</div>
    </div>

    <!-- Group Preview (hidden by default) -->
    <div id="preview" class="hidden">
      <div class="group-avatar" id="avatar-container">üë•</div>
      <div class="group-name" id="group-name"></div>
      <div class="group-members" id="group-members"></div>
      <div class="group-desc" id="group-desc"></div>
      <div class="invite-badge">‚úâÔ∏è B·∫°n ƒë∆∞·ª£c m·ªùi tham gia nh√≥m n√†y</div>
      <a href="#" id="btn-open" class="btn-open" onclick="openApp()">
        üì± M·ªü trong ·ª©ng d·ª•ng
      </a>
      <a
        href="https://github.com/duchieuqodes/Bansungrank/releases/download/app-chat2/chutchill.apk"
        class="btn-download"
        id="btn-download"
      >
        ‚¨áÔ∏è T·∫£i app Ch√∫t Chill
      </a>
      <div class="status-text" id="status-text"></div>
    </div>

    <!-- Error State (hidden by default) -->
    <div id="error" class="hidden">
      <div class="error-icon">üîó</div>
      <div class="error-title" id="error-title">Link kh√¥ng h·ª£p l·ªá</div>
      <div class="error-sub" id="error-sub">Link m·ªùi n√†y ƒë√£ h·∫øt h·∫°n ho·∫∑c b·ªã thu h·ªìi.</div>
      <a
        href="https://github.com/duchieuqodes/Bansungrank/releases/download/app-chat2/chutchill.apk"
        class="btn-download"
      >
        ‚¨áÔ∏è T·∫£i app Ch√∫t Chill
      </a>
    </div>
  </div>

  <script>
    // ============================================
    // CONFIG ‚Äî THAY ƒê·ªîI THEO D·ª∞ √ÅN
    // ============================================
    const SUPABASE_URL = 'YOUR_SUPABASE_URL';  // ‚Üê Thay b·∫±ng URL th·∫≠t
    const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY'; // ‚Üê Thay b·∫±ng key th·∫≠t
    const APP_SCHEME = 'chutchill';
    const APK_URL = 'https://github.com/duchieuqodes/Bansungrank/releases/download/app-chat2/chutchill.apk';

    // ============================================
    // L·∫§Y INVITE CODE T·ª™ URL
    // ============================================
    function getInviteCode() {
      const parts = window.location.pathname.split('/');
      const idx = parts.indexOf('invite');
      return idx >= 0 && parts[idx + 1] ? parts[idx + 1] : null;
    }

    // ============================================
    // FETCH TH√îNG TIN NH√ìM T·ª™ SUPABASE
    // ============================================
    async function fetchGroupInfo(inviteCode) {
      try {
        // 1. L·∫•y link info
        const linkRes = await fetch(
          `${SUPABASE_URL}/rest/v1/group_invite_links?invite_code=eq.${inviteCode}&is_active=eq.true&select=*&limit=1`,
          { headers: { apikey: SUPABASE_ANON_KEY, Authorization: `Bearer ${SUPABASE_ANON_KEY}` } }
        );
        const links = await linkRes.json();
        if (!links || links.length === 0) return null;
        const link = links[0];

        // Ki·ªÉm tra h·∫øt h·∫°n
        if (link.expires_at && new Date(link.expires_at) < new Date()) return null;
        // Ki·ªÉm tra max uses
        if (link.max_uses && link.used_count >= link.max_uses) return null;

        // 2. L·∫•y group info
        const groupRes = await fetch(
          `${SUPABASE_URL}/rest/v1/groups?id=eq.${link.group_id}&select=id,name,avatar_url,description&limit=1`,
          { headers: { apikey: SUPABASE_ANON_KEY, Authorization: `Bearer ${SUPABASE_ANON_KEY}` } }
        );
        const groups = await groupRes.json();
        if (!groups || groups.length === 0) return null;
        const group = groups[0];

        // 3. ƒê·∫øm th√†nh vi√™n
        const countRes = await fetch(
          `${SUPABASE_URL}/rest/v1/group_members?group_id=eq.${link.group_id}&status=eq.active&select=id`,
          { headers: { apikey: SUPABASE_ANON_KEY, Authorization: `Bearer ${SUPABASE_ANON_KEY}`, Prefer: 'count=exact' } }
        );
        const countHeader = countRes.headers.get('content-range');
        const memberCount = countHeader ? parseInt(countHeader.split('/')[1]) || 0 : 0;

        return {
          name: group.name,
          avatar_url: group.avatar_url,
          description: group.description,
          members_count: memberCount,
        };
      } catch (err) {
        console.error('Fetch error:', err);
        return null;
      }
    }

    // ============================================
    // M·ªû APP
    // ============================================
    function openApp() {
      const code = getInviteCode();
      if (!code) return;

      const deepLink = `${APP_SCHEME}://invite/${code}`;
      const statusEl = document.getElementById('status-text');

      // Th·ª≠ m·ªü deep link
      statusEl.textContent = 'ƒêang m·ªü ·ª©ng d·ª•ng...';

      // D√πng intent cho Android
      const isAndroid = /android/i.test(navigator.userAgent);
      const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);

      if (isAndroid) {
        // Th·ª≠ deep link tr∆∞·ªõc, fallback t·∫£i APK
        window.location.href = deepLink;
        setTimeout(() => {
          statusEl.textContent = 'Kh√¥ng t√¨m th·∫•y app? H√£y t·∫£i app b√™n d∆∞·ªõi.';
        }, 2500);
      } else if (isIOS) {
        window.location.href = deepLink;
        setTimeout(() => {
          statusEl.textContent = 'N·∫øu app kh√¥ng m·ªü, h√£y t·∫£i app.';
        }, 2500);
      } else {
        // Desktop: hi·ªán h∆∞·ªõng d·∫´n
        statusEl.textContent = 'Vui l√≤ng m·ªü link n√†y tr√™n ƒëi·ªán tho·∫°i ƒë·ªÉ s·ª≠ d·ª•ng app.';
      }
    }

    // ============================================
    // INIT
    // ============================================
    async function init() {
      const code = getInviteCode();
      const loadingEl = document.getElementById('loading');
      const previewEl = document.getElementById('preview');
      const errorEl = document.getElementById('error');

      if (!code) {
        loadingEl.classList.add('hidden');
        errorEl.classList.remove('hidden');
        document.getElementById('error-title').textContent = 'Link kh√¥ng h·ª£p l·ªá';
        document.getElementById('error-sub').textContent = 'ƒê∆∞·ªùng d·∫´n n√†y kh√¥ng ch·ª©a m√£ m·ªùi h·ª£p l·ªá.';
        return;
      }

      const info = await fetchGroupInfo(code);

      loadingEl.classList.add('hidden');

      if (!info) {
        errorEl.classList.remove('hidden');
        return;
      }

      // Hi·ªÉn th·ªã preview
      document.getElementById('group-name').textContent = info.name;
      document.getElementById('group-members').textContent = `üë• ${info.members_count} th√†nh vi√™n`;

      if (info.description) {
        document.getElementById('group-desc').textContent = info.description;
      } else {
        document.getElementById('group-desc').style.display = 'none';
      }

      if (info.avatar_url && info.avatar_url.startsWith('http')) {
        document.getElementById('avatar-container').innerHTML =
          `<img src="${info.avatar_url}" alt="${info.name}" onerror="this.parentElement.textContent='üë•'" />`;
      }

      previewEl.classList.remove('hidden');

      // Auto-try m·ªü app tr√™n mobile
      const isMobile = /android|iphone|ipad|ipod/i.test(navigator.userAgent);
      if (isMobile) {
        setTimeout(() => openApp(), 800);
      }
    }

    init();
  </script>
</body>
</html>
